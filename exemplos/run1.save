#!/bin/bash
#
# (C) 2024 Docentes de Programação/MEEC
#
# Shell script para correr testes a um projecto de CIFRAS
# programas a correr
PROG_ALUNOS="./cifras"
VALGRIND="time valgrind --leak-check=full --show-leak-kinds=all "
DIFF="diff --text"
# opções para o time
export TIME="real %E\tuser %U\tsys %S\texit status %x\t%I inputs + %O outputs"
INPUT=in
OUTPUT=out1
EXPECTED=expected1
DECODED_CESAR=cesar1
DECODED_VIGENERE=vigenere1

if ( ! [ -d $INPUT ] ); then
  echo A pasta com os inputs não existe no caminho definido na variável INPUT como $INPUT.
  echo Por favor faça unzip do exemplos.zip e defina o caminho na variável INPUT na linha 12 deste script
  exit 1 
fi
if ( ! [ -d $EXPECTED ] ); then
  echo A pasta com os outputs esperados não existe no caminho definido na variável EXPECTED como $EXPECTED.
  echo Por favor faça unzip do exemplos.zip e defina o caminho na variável EXPECTED na linha 14 deste script
  exit 1 
fi
if ( ! [ -x $PROG_ALUNOS ] ); then
  echo ERRO: O programa $PROG_ALUNOS não existe com este nome.
  exit 1 
fi
# Criar directorias, caso não existam
if ( ! [ -d $OUTPUT ] ); then
  mkdir $OUTPUT
fi
if ( ! [ -d $DECODED_CESAR ] ); then
  mkdir $DECODED_CESAR
fi
if ( ! [ -d $DECODED_VIGENERE ] ); then
  mkdir $DECODED_VIGENERE
fi
# Percorrer os ficheiros todos, cifrando e decifrando
for file in $INPUT/*; do
  echo -e "\e[7mFicheiro $file\e[0m"
  filename=`echo $file | sed "s/$INPUT\///g ; s/\.txt//g"`
  # fase 1, stdin e stdout
  $VALGRIND $PROG_ALUNOS -c 1 < $file > $OUTPUT/$filename-cesar.txt
  $VALGRIND $PROG_ALUNOS -d 1 < $EXPECTED/$filename-cesar.txt > $DECODED_CESAR/$filename.txt
  $VALGRIND $PROG_ALUNOS -c 2 < $file > $OUTPUT/$filename-vigenere.txt
  $VALGRIND $PROG_ALUNOS -d 2 < $EXPECTED/$filename-vigenere.txt > $DECODED_VIGENERE/$filename.txt
  $VALGRIND $PROG_ALUNOS -c 1 -f < $file > $OUTPUT/$filename-cesar-filtrado.txt
  $VALGRIND $PROG_ALUNOS -d 1 -f < $EXPECTED/$filename-cesar-filtrado.txt > $OUTPUT/$filename-filtrado.txt
  $VALGRIND $PROG_ALUNOS -c 2 -f < $file > $OUTPUT/$filename-vigenere-filtrado.txt
  $VALGRIND $PROG_ALUNOS -d 2 -f < $EXPECTED/$filename-vigenere-filtrado.txt > $OUTPUT/$filename-filtrado.txt
done
# Comparar as directorias
$DIFF -r $OUTPUT $EXPECTED
if [ $? -eq 0 ]; then
  echo Cifras OK
else
  echo ERRO detectado nos ficheiros Cifrados
fi
$DIFF -r $INPUT $DECODED_CESAR
if [ $? -eq 0 ]; then
  echo Decifra César OK
else
  echo ERRO detectado na decifra de César
fi
$DIFF -r $INPUT $DECODED_VIGENERE
if [ $? -eq 0 ]; then
  echo Decifra Vigenère OK
else
  echo ERRO detectado na decifra de Vigenère
fi

